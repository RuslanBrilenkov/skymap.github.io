<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sky Survey Coverage Explorer (Dev)</title>
    <link rel="icon" href="favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <!-- Aladin Lite v2 (stable) -->
    <link rel="stylesheet" href="https://aladin.cds.unistra.fr/AladinLite/api/v2/latest/aladin.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://aladin.cds.unistra.fr/AladinLite/api/v2/latest/aladin.min.js" charset="utf-8"></script>
    <!-- D3.js for equirectangular map -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="brand">
          <h1>Sky Coverage Explorer</h1>
          <p>Dev build for survey MOC visualization</p>
        </div>

        <section class="section">
          <h2>Surveys</h2>
          <div class="survey-dropdown" id="survey-dropdown">
            <button class="dropdown-toggle" id="survey-toggle" type="button"
                    aria-expanded="false" aria-haspopup="listbox" aria-controls="survey-panel">
              Select Survey(s)
            </button>
            <div class="dropdown-panel" id="survey-panel">
              <div class="survey-list" id="survey-list"></div>
            </div>
          </div>
        </section>

        <section class="section">
          <h2>Legend</h2>
          <div class="legend-list" id="legend-list"></div>
        </section>

        <section class="section">
          <h2>Coverage</h2>
          <div class="stats" id="coverage-stats">
            <div class="stat-card">
              <strong id="selected-count">0</strong>
              <span>Surveys selected</span>
            </div>
            <div class="stat-card">
              <strong id="intersection-area">--</strong>
              <span>Intersection area (sq deg)</span>
            </div>
          </div>
          <div class="log" id="coverage-log"></div>
        </section>

        <section class="section">
          <h2>Actions</h2>
          <div class="actions">
            <label class="toggle">
              <input type="checkbox" id="crossmatch-toggle" />
              <span>Show cross-match only</span>
            </label>
            <button class="button secondary" id="upload-button">Upload catalog</button>
            <input type="file" id="upload-input" accept=".csv,.tsv,text/csv,text/tab-separated-values" hidden />
            <button class="button secondary" id="clear-catalog-button" disabled>Clear catalog</button>
            <button class="button" id="download-button" disabled>
              Download catalog (augmented)
            </button>
            <button class="button secondary" id="reset-button">Reset</button>
          </div>
        </section>

        <section class="section">
          <h2>Color Theme</h2>
          <div class="theme-picker">
            <select id="theme-select" aria-label="Select color theme">
              <option value="default">Vivid</option>
              <option value="colorblind">Color-blind friendly</option>
              <option value="pastel">Pastel</option>
            </select>
          </div>
        </section>

        <section class="section">
          <h2>Preferences</h2>
          <label class="toggle">
            <input type="checkbox" id="persist-toggle" />
            <span>Remember selections on this device</span>
          </label>
        </section>

        <section class="section">
          <h2>Status</h2>
          <div class="status-pill" id="moc-status">MOC engine: checking</div>
          <div class="status-text" id="map-status">Ready</div>
        </section>
      </aside>

      <main class="map-panel">
        <div class="topbar">
          <strong id="map-title">Aladin Lite V2</strong>
          <div class="view-toggle">
            <button class="view-btn is-active" id="view-aladin" data-view="aladin" title="Interactive globe view with Aladin Lite">
              Aladin
            </button>
            <button class="view-btn" id="view-equirect" data-view="equirectangular" title="Equirectangular projection (RA/Dec grid)">
              Equirectangular
            </button>
          </div>
          <div class="equirect-controls" id="equirect-controls" style="display: none;">
            <label class="control-checkbox">
              <input type="checkbox" id="show-grid" checked />
              <span>Grid</span>
            </label>
            <label class="control-checkbox">
              <input type="checkbox" id="show-galactic" checked />
              <span>Galactic</span>
            </label>
            <label class="control-checkbox">
              <input type="checkbox" id="show-ecliptic" checked />
              <span>Ecliptic</span>
            </label>
          </div>
          <div class="theme-toggle" role="group" aria-label="UI theme">
            <span class="theme-toggle__label">Dark</span>
            <label class="theme-toggle__switch">
              <input type="checkbox" id="ui-theme-toggle" aria-label="Toggle light mode" />
              <span class="theme-toggle__slider" aria-hidden="true"></span>
            </label>
            <span class="theme-toggle__label">Light</span>
          </div>
        </div>
        <div class="map-overlay" id="map-overlay" aria-hidden="true">
          <div class="spinner"></div>
          <span>Updating mapâ€¦</span>
        </div>
        <div class="toast-stack" id="toast-stack" aria-live="polite"></div>
        <div id="aladin-lite-div" style="width: 100%; height: calc(100% - 40px);"></div>
        <div id="equirectangular-map" style="width: 100%; height: calc(100% - 40px); display: none;">
          <svg id="sky-map"></svg>
        </div>
      </main>
    </div>

    <script type="module">
      import init, * as moc from "./moc-wasm/pkg/moc.js";

      window.mocReady = init()
        .then(() => {
          window.mocWasm = moc;
          return moc;
        })
        .catch((error) => {
          console.error("Failed to initialize MOC wasm:", error);
          throw error;
        });
    </script>
    <script type="module" src="app.js?v=1.13.3"></script>
  </body>
</html>
